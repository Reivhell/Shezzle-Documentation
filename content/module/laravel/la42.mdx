---
title: "Sesi 42: Authorization: Gates & Policies"
description: "Menguasai sistem authorization Laravel dengan Gates untuk logic sederhana dan Policies untuk resource-based authorization, serta implementasi RBAC."
category: "laravel"
tags: ["laravel", "authentication"]
order: 42
---

## Tujuan Pembelajaran

Menguasai sistem authorization Laravel dengan Gates untuk logic sederhana dan Policies untuk resource-based authorization, serta implementasi RBAC.

## 1. Gates

### 1.1 Defining Gates

```php
<?php

// app/Providers/AppServiceProvider.php
use Illuminate\Support\Facades\Gate;

public function boot(): void
{
    // Gate sederhana
    Gate::define('edit-settings', function (User $user) {
        return $user->isAdmin();
    });

    // Gate dengan parameter tambahan
    Gate::define('update-post', function (User $user, Post $post) {
        return $user->id === $post->user_id;
    });

    // Gate dengan multiple conditions
    Gate::define('delete-comment', function (User $user, Comment $comment) {
        return $user->id === $comment->user_id 
            || $user->id === $comment->post->user_id 
            || $user->isModerator();
    });

    // Gate dengan class method
    Gate::define('subscribe-premium', [SubscriptionGate::class, 'subscribe']);
}
```

```php
<?php

// app/Gates/SubscriptionGate.php
namespace App\Gates;

use App\Models\User;

class SubscriptionGate
{
    public function subscribe(User $user): bool
    {
        return $user->email_verified_at !== null 
            && !$user->isBanned()
            && $user->paymentMethods()->exists();
    }
}
```

### 1.2 Authorizing Actions

```php
<?php

// Dalam controller
public function update(Request $request, Post $post)
{
    // Method 1: Gate facade
    if (!Gate::allows('update-post', $post)) {
        abort(403);
    }

    // Method 2: denies
    if (Gate::denies('update-post', $post)) {
        abort(403);
    }

    // Method 3: authorize helper (throw 403 jika gagal)
    Gate::authorize('update-post', $post);

    // Method 4: forUser (check untuk user lain)
    if (Gate::forUser($otherUser)->allows('update-post', $post)) {
        // ...
    }

    // Method 5: any/none
    if (Gate::any(['update-post', 'admin-post'], $post)) {
        // User bisa salah satu
    }

    if (Gate::none(['update-post', 'delete-post'], $post)) {
        // User tidak bisa keduanya
    }

    // Update post
    $post->update($request->validated());
}
```

### 1.3 Gate Before/After

```php
<?php

// app/Providers/AppServiceProvider.php
public function boot(): void
{
    // Before - check pertama sebelum gates lain
    Gate::before(function (User $user, string $ability) {
        // Superadmin bypass semua gates
        if ($user->isSuperAdmin()) {
            return true;
        }
        
        // Banned user tidak bisa apa-apa
        if ($user->isBanned()) {
            return false;
        }
    });

    // After - check terakhir
    Gate::after(function (User $user, string $ability, bool|null $result, mixed $arguments) {
        // Log semua authorization attempts
        AuthorizationLog::create([
            'user_id' => $user->id,
            'ability' => $ability,
            'result' => $result,
            'ip' => request()->ip(),
        ]);
        
        return $result;
    });
}
```

## 2. Policies

### 2.1 Creating Policies

```bash
# Generate policy
php artisan make:policy PostPolicy --model=Post

# Generate dengan controller
php artisan make:policy PostPolicy --model=Post --controller
```

```php
<?php

// app/Policies/PostPolicy.php
namespace App\Policies;

use App\Models\Post;
use App\Models\User;

class PostPolicy
{
    /**
     * Determine whether the user can view any models.
     */
    public function viewAny(User $user): bool
    {
        return true; // Semua user bisa lihat list posts
    }

    /**
     * Determine whether the user can view the model.
     */
    public function view(User $user, Post $post): bool
    {
        // Bisa lihat jika published atau pemilik
        return $post->isPublished() || $user->id === $post->user_id;
    }

    /**
     * Determine whether the user can create models.
     */
    public function create(User $user): bool
    {
        return $user->hasVerifiedEmail() && !$user->isBanned();
    }

    /**
     * Determine whether the user can update the model.
     */
    public function update(User $user, Post $post): bool
    {
        return $user->id === $post->user_id;
    }

    /**
     * Determine whether the user can delete the model.
     */
    public function delete(User $user, Post $post): bool
    {
        return $user->id === $post->user_id || $user->isModerator();
    }

    /**
     * Determine whether the user can restore the model.
     */
    public function restore(User $user, Post $post): bool
    {
        return $user->isModerator();
    }

    /**
     * Determine whether the user can permanently delete the model.
     */
    public function forceDelete(User $user, Post $post): bool
    {
        return $user->isAdmin();
    }
}
```

### 2.2 Registering Policies

```php
<?php

// app/Providers/AppServiceProvider.php
use App\Models\Post;
use App\Policies\PostPolicy;

public function boot(): void
{
    Gate::policy(Post::class, PostPolicy::class);
}

// Atau Policy auto-discovery (Laravel 10+)
// Nama policy mengikuti konvensi: ModelNamePolicy
```

### 2.3 Using Policies

```php
<?php

// Dalam controller
class PostController extends Controller
{
    public function index()
    {
        $this->authorize('viewAny', Post::class);
        
        return Post::paginate();
    }

    public function show(Post $post)
    {
        $this->authorize('view', $post);
        
        return $post;
    }

    public function update(Request $request, Post $post)
    {
        $this->authorize('update', $post);
        
        $post->update($request->validated());
        return $post;
    }

    public function destroy(Post $post)
    {
        $this->authorize('delete', $post);
        
        $post->delete();
        return response()->noContent();
    }
}
```

### 2.4 Policy Responses

```php
<?php

// Custom denial message
public function update(User $user, Post $post): Response
{
    return $user->id === $post->user_id
        ? Response::allow()
        : Response::deny('You do not own this post.');
}

// Dengan reason code
public function delete(User $user, Post $post): Response
{
    if ($post->isPublished()) {
        return Response::denyWithStatus(403, 'Cannot delete published posts.');
    }

    return $user->id === $post->user_id
        ? Response::allow()
        : Response::deny('You do not own this post.', 403);
}
```

## 3. Blade Authorization

### 3.1 @can dan @cannot

```blade
{{-- resources/views/posts/show.blade.php --}}

@can('update', $post)
    <a href="{{ route('posts.edit', $post) }}" class="btn btn-primary">
        Edit Post
    </a>
@endcan

@cannot('delete', $post)
    <span class="text-muted">You cannot delete this post</span>
@else
    <form action="{{ route('posts.destroy', $post) }}" method="POST">
        @csrf @method('DELETE')
        <button type="submit" class="btn btn-danger">Delete</button>
    </form>
@endcannot

{{-- Multiple abilities --}}
@canany(['update', 'delete'], $post)
    <div class="post-actions">
        {{-- User bisa update ATAU delete --}}
    </div>
@endcanany

@cannotany(['update', 'delete'], $post)
    <p>You have no permissions for this post.</p>
@endcannotany
```

### 3.2 @guest dan @auth

```blade
@auth
    {{-- User logged in --}}
    Welcome, {{ auth()->user()->name }}
    
    @can('create', App\Models\Post::class)
        <a href="{{ route('posts.create') }}">Create Post</a>
    @endcan
@endauth

@guest
    {{-- User not logged in --}}
    <a href="{{ route('login') }}">Login</a> to create posts.
@endguest
```

## 4. Resource Policies

### 4.1 Controller dengan Policy

```php
<?php

// app/Http/Controllers/PostController.php
class PostController extends Controller
{
    public function __construct()
    {
        // Apply policy ke semua methods
        $this->authorizeResource(Post::class, 'post');
    }

    public function index()
    {
        return Post::paginate();
    }

    public function create()
    {
        return view('posts.create');
    }

    public function store(Request $request)
    {
        $post = auth()->user()->posts()->create($request->validated());
        return redirect()->route('posts.show', $post);
    }

    public function show(Post $post)
    {
        return view('posts.show', compact('post'));
    }

    public function edit(Post $post)
    {
        return view('posts.edit', compact('post'));
    }

    public function update(Request $request, Post $post)
    {
        $post->update($request->validated());
        return redirect()->route('posts.show', $post);
    }

    public function destroy(Post $post)
    {
        $post->delete();
        return redirect()->route('posts.index');
    }
}
```

> **tip**
>
**authorizeResource** otomatis map controller methods ke policy methods:
- index → viewAny
- create, store → create
- show → view
- edit, update → update
- destroy → delete

### 4.2 Nested Resources

```php
<?php

// Policy untuk nested resource (comment dalam post)
class CommentPolicy
{
    public function create(User $user, Post $post): bool
    {
        // Bisa comment jika post published dan user verified
        return $post->isPublished() && $user->hasVerifiedEmail();
    }

    public function update(User $user, Comment $comment, Post $post): bool
    {
        return $user->id === $comment->user_id && $comment->post_id === $post->id;
    }
}
```

```php
<?php

// Controller
public function store(Request $request, Post $post)
{
    $this->authorize('create', [Comment::class, $post]);
    
    $comment = $post->comments()->create([
        ...$request->validated(),
        'user_id' => auth()->id(),
    ]);
    
    return $comment;
}
```

## 5. Role-Based Access Control (RBAC)

### 5.1 Simple RBAC dengan Gates

```php
<?php

// app/Providers/AppServiceProvider.php
public function boot(): void
{
    $roles = ['admin', 'editor', 'author', 'subscriber'];
    
    foreach ($roles as $role) {
        Gate::define($role, function (User $user) use ($role) {
            return $user->role === $role;
        });
    }

    // Permission-based gates
    $permissions = [
        'publish-posts',
        'edit-any-post',
        'delete-any-post',
        'manage-users',
        'manage-settings',
    ];

    foreach ($permissions as $permission) {
        Gate::define($permission, function (User $user) use ($permission) {
            return $user->hasPermission($permission);
        });
    }
}
```

```php
<?php

// app/Models/User.php
class User extends Authenticatable
{
    public function hasPermission(string $permission): bool
    {
        $rolePermissions = [
            'admin' => ['*'],
            'editor' => ['publish-posts', 'edit-any-post', 'delete-any-post'],
            'author' => ['publish-posts'],
            'subscriber' => [],
        ];

        $permissions = $rolePermissions[$this->role] ?? [];

        return in_array('*', $permissions) || in_array($permission, $permissions);
    }
}
```

### 5.2 Database-Driven RBAC

```php
<?php

// Migration untuk roles dan permissions
Schema::create('roles', function (Blueprint $table) {
    $table->id();
    $table->string('name')->unique();
    $table->string('label');
    $table->timestamps();
});

Schema::create('permissions', function (Blueprint $table) {
    $table->id();
    $table->string('name')->unique();
    $table->string('label');
    $table->timestamps();
});

Schema::create('role_permission', function (Blueprint $table) {
    $table->foreignId('role_id')->constrained()->cascadeOnDelete();
    $table->foreignId('permission_id')->constrained()->cascadeOnDelete();
    $table->primary(['role_id', 'permission_id']);
});

Schema::create('user_role', function (Blueprint $table) {
    $table->foreignId('user_id')->constrained()->cascadeOnDelete();
    $table->foreignId('role_id')->constrained()->cascadeOnDelete();
    $table->primary(['user_id', 'role_id']);
});
```

```php
<?php

// app/Models/User.php dengan roles
class User extends Authenticatable
{
    public function roles()
    {
        return $this->belongsToMany(Role::class);
    }

    public function hasRole($roles): bool
    {
        if (is_string($roles)) {
            return $this->roles->contains('name', $roles);
        }

        return $this->roles->whereIn('name', $roles)->isNotEmpty();
    }

    public function hasPermission($permission): bool
    {
        return $this->roles->flatMap->permissions->contains('name', $permission);
    }
}
```

```php
<?php

// Policy dengan RBAC
class PostPolicy
{
    public function update(User $user, Post $post): bool
    {
        // Owner atau editor/admin
        return $user->id === $post->user_id 
            || $user->hasPermission('edit-any-post');
    }

    public function delete(User $user, Post $post): bool
    {
        return $user->id === $post->user_id 
            || $user->hasRole(['admin', 'moderator']);
    }
}
```

## 6. Testing Authorization

```php
<?php

// tests/Feature/PostAuthorizationTest.php
class PostAuthorizationTest extends TestCase
{
    use RefreshDatabase;

    public function test_user_can_update_own_post()
    {
        $user = User::factory()->create();
        $post = Post::factory()->create(['user_id' => $user->id]);

        $response = $this->actingAs($user)
            ->putJson("/api/posts/{$post->id}", ['title' => 'Updated']);

        $response->assertOk();
    }

    public function test_user_cannot_update_others_post()
    {
        $user = User::factory()->create();
        $otherUser = User::factory()->create();
        $post = Post::factory()->create(['user_id' => $otherUser->id]);

        $response = $this->actingAs($user)
            ->putJson("/api/posts/{$post->id}", ['title' => 'Updated']);

        $response->assertForbidden();
    }

    public function test_admin_can_update_any_post()
    {
        $admin = User::factory()->create(['role' => 'admin']);
        $post = Post::factory()->create();

        $response = $this->actingAs($admin)
            ->putJson("/api/posts/{$post->id}", ['title' => 'Updated']);

        $response->assertOk();
    }

    public function test_guest_cannot_create_post()
    {
        $response = $this->postJson('/api/posts', ['title' => 'New Post']);

        $response->assertUnauthorized();
    }
}
```

## Kesimpulan

Gates dan Policies menyediakan sistem authorization yang fleksibel:
- **Gates** untuk authorization logic sederhana dan closure-based
- **Policies** untuk resource-based authorization dengan konvensi CRUD
- **Blade directives** untuk UI authorization yang clean
- **RBAC** untuk role dan permission management yang scalable

Selanjutnya di **Sesi 43**, kita akan mempelajari Advanced Authorization Patterns.
```
