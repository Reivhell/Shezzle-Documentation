---
title: "Sesi 12: Service Providers"
description: "Service Providers adalah \"jantung\" bootstrapping Laravel. Mereka mengajarkan aplikasi cara bekerja—dari mana mengambil database connection, bagaimana ..."
category: "laravel"
tags: ["laravel", "architecture"]
order: 12
---

## 12.1 Provider Lifecycle: register() vs boot()

Service Providers adalah "jantung" bootstrapping Laravel. Mereka mengajarkan aplikasi cara bekerja—dari mana mengambil database connection, bagaimana memproses view, hingga cara menangani queue.

> **tip**
>
  Analogi sederhana: Service provider seperti pegawai di restoran. `register()` adalah saat pegawai melapor dan mengenalkan diri (saya adalah waiter, saya adalah chef). `boot()` adalah saat pegawai mulai bekerja setelah semua pegawai lain siap.

### 12.1.1 Struktur Dasar Service Provider

```php
<?php

namespace App\Providers;

use Illuminate\Support\ServiceProvider;

class PaymentServiceProvider extends ServiceProvider
{
    /**
     * Register services.
     * 
     * Dipanggil pertama, hanya untuk binding ke container.
     * DI SINI: Jangan akses services lain, mereka belum siap!
     */
    public function register(): void
    {
        // Binding interface ke implementation
        $this->app->bind(
            \App\Contracts\PaymentGateway::class,
            \App\Services\StripePaymentGateway::class
        );

        // Singleton untuk expensive service
        $this->app->singleton(
            \App\Services\PaymentProcessor::class,
            function ($app) {
                return new \App\Services\PaymentProcessor(
                    $app->make(\App\Contracts\PaymentGateway::class)
                );
            }
        );
    }

    /**
     * Bootstrap services.
     * 
     * Dipanggil SETELAH semua register() selesai.
     * DI SINI: Semua services sudah tersedia, bisa digunakan!
     */
    public function boot(): void
    {
        // Akses config (sudah tersedia)
        $config = config('services.stripe');

        // Register event listeners
        \App\Events\OrderCreated::listen(function ($event) {
            // Process payment
        });

        // Register view composers
        \Illuminate\Support\Facades\View::composer(
            'checkout.*',
            \App\Http\View\Composers\PaymentComposer::class
        );

        // Register routes (jika provider punya routes)
        $this->loadRoutesFrom(__DIR__.'/../../routes/payment.php');
    }
}
```

### 12.1.2 Urutan Eksekusi

```php
<?php

// 1. Laravel instantiate semua providers dari config/app.php
// 2. Panggil register() pada SEMUA providers (secara berurutan)
// 3. Panggil boot() pada SEMUA providers (secara berurutan)

// Contoh urutan:
$providers = [
    \App\Providers\AppServiceProvider::class,      // register() → boot()
    \App\Providers\AuthServiceProvider::class,     // register() → boot()
    \App\Providers\EventServiceProvider::class,    // register() → boot()
    \App\Providers\RouteServiceProvider::class,    // register() → boot()
    \App\Providers\PaymentServiceProvider::class,  // register() → boot()
];

// Semua register() dipanggil dulu, baru semua boot()
```

### 12.1.3 Register Method: Do's and Don'ts

```php
<?php

public function register(): void
{
    // ✅ DO: Binding ke container
    $this->app->bind(Interface::class, Implementation::class);
    $this->app->singleton(SingletonService::class);
    $this->app->scoped(ScopedService::class);
    $this->app->instance('key', $value);

    // ✅ DO: Merge config
    $this->mergeConfigFrom(
        __DIR__.'/../config/payment.php',
        'payment'
    );

    // ❌ DON'T: Akses services lain
    // auth()->user(); // ERROR: Auth belum siap!
    // config('app.name'); // Aman, tapi hindari jika bisa
    // View::composer(...); // ERROR: View belum siap!
    // Route::get(...); // ERROR: Router belum siap!

    // ❌ DON'T: Database operations
    // User::first(); // ERROR: DB belum siap!
}
```

### 12.1.4 Boot Method: Full Power

```php
<?php

public function boot(): void
{
    // ✅ Semua services sudah tersedia di sini!

    // Akses config
    $apiKey = config('services.stripe.key');

    // Database operations
    $settings = \App\Models\Setting::all();

    // Register view composers
    \View::composer('dashboard', function ($view) {
        $view->with('stats', \App\Models\Stat::today());
    });

    // Register Blade directives
    \Blade::directive('money', function ($expression) {
        return "<?php echo 'Rp ' . number_format($expression, 0, ',', '.'); ?>";
    });

    // Register middleware
    $router = $this->app->make(\Illuminate\Routing\Router::class);
    $router->pushMiddlewareToGroup('web', \App\Http\Middleware\TrackVisitor::class);

    // Register event listeners
    \Event::listen(\App\Events\OrderPaid::class, \App\Listeners\SendReceipt::class);

    // Register console commands
    if ($this->app->runningInConsole()) {
        $this->commands([
            \App\Console\Commands\ProcessPayments::class,
        ]);
    }
}
```

---

## 12.2 Deferred Providers untuk Performance

Deferred providers tidak di-load sampai services-nya benar-benar dibutuhkan—hemat memory dan waktu boot.

### 12.2.1 Membuat Deferred Provider

```php
<?php

namespace App\Providers;

use Illuminate\Contracts\Support\DeferrableProvider;
use Illuminate\Support\ServiceProvider;

class AnalyticsServiceProvider extends ServiceProvider implements DeferrableProvider
{
    /**
     * Provider ini tidak di-load saat boot!
     * Hanya di-load saat AnalyticsService di-resolve.
     */

    public function register(): void
    {
        $this->app->singleton(\App\Services\AnalyticsService::class, function ($app) {
            return new \App\Services\AnalyticsService(
                config('services.analytics.api_key')
            );
        });
    }

    /**
     * Daftar services yang disediakan provider ini.
     * Laravel menggunakan ini untuk menentukan kapan provider harus di-load.
     */
    public function provides(): array
    {
        return [
            \App\Services\AnalyticsService::class,
        ];
    }

    public function boot(): void
    {
        // Ini hanya dipanggil saat AnalyticsService pertama kali digunakan!
        \Log::info('AnalyticsServiceProvider booted');
    }
}
```

### 12.2.2 Kapan Menggunakan Deferred Provider?

| Skenario | Gunakan Deferred? |
|----------|-------------------|
| Service jarang digunakan | ✅ Ya |
| Service expensive untuk instantiate | ✅ Ya |
| Service hanya di console commands | ✅ Ya |
| Service selalu digunakan di setiap request | ❌ Tidak |
| Critical path aplikasi | ❌ Tidak |

### 12.2.3 Multiple Provides

```php
<?php

class PaymentServiceProvider extends ServiceProvider implements DeferrableProvider
{
    public function register(): void
    {
        $this->app->singleton(\App\Services\PaymentGateway::class, function ($app) {
            return new \App\Services\StripeGateway();
        });

        $this->app->singleton(\App\Services\InvoiceGenerator::class, function ($app) {
            return new \App\Services\PdfInvoiceGenerator();
        });

        $this->app->singleton(\App\Services\ReceiptSender::class, function ($app) {
            return new \App\Services\EmailReceiptSender();
        });
    }

    public function provides(): array
    {
        // Semua services yang disediakan
        return [
            \App\Services\PaymentGateway::class,
            \App\Services\InvoiceGenerator::class,
            \App\Services\ReceiptSender::class,
        ];
    }
}
```

---

## 12.3 Custom Service Provider Creation

### 12.3.1 Generate Provider

```bash
php artisan make:provider PaymentServiceProvider
```

### 12.3.2 Register di config/app.php

```php
<?php

// config/app.php

return [
    'providers' => [
        // Laravel Framework Service Providers
        \Illuminate\Auth\AuthServiceProvider::class,
        \Illuminate\Broadcasting\BroadcastServiceProvider::class,
        // ... framework providers

        // Application Service Providers
        \App\Providers\AppServiceProvider::class,
        \App\Providers\AuthServiceProvider::class,
        \App\Providers\EventServiceProvider::class,
        \App\Providers\RouteServiceProvider::class,

        // Custom Providers
        \App\Providers\PaymentServiceProvider::class,
        \App\Providers\NotificationServiceProvider::class,
        \App\Providers\RepositoryServiceProvider::class,
    ],
];
```

### 12.3.3 Repository Pattern Provider

```php
<?php

namespace App\Providers;

use Illuminate\Support\ServiceProvider;

class RepositoryServiceProvider extends ServiceProvider
{
    /**
     * Map interface ke implementation
     */
    protected array $repositories = [
        \App\Contracts\Repositories\UserRepository::class 
            => \App\Repositories\EloquentUserRepository::class,
        
        \App\Contracts\Repositories\PostRepository::class 
            => \App\Repositories\EloquentPostRepository::class,
        
        \App\Contracts\Repositories\OrderRepository::class 
            => \App\Repositories\EloquentOrderRepository::class,
    ];

    public function register(): void
    {
        foreach ($this->repositories as $interface => $implementation) {
            $this->app->bind($interface, $implementation);
        }
    }

    public function boot(): void
    {
        // Global query constraints
        \App\Models\Post::addGlobalScope('published', function ($builder) {
            $builder->where('status', 'published');
        });
    }
}
```

### 12.3.4 Multi-tenancy Provider

```php
<?php

namespace App\Providers;

use Illuminate\Support\ServiceProvider;

class TenancyServiceProvider extends ServiceProvider
{
    public function register(): void
    {
        $this->app->singleton(\App\Services\TenantManager::class, function ($app) {
            return new \App\Services\TenantManager(
                $app->make(\Illuminate\Http\Request::class)
            );
        });

        // Contextual binding untuk tenant-specific services
        $this->app->when(\App\Services\DatabaseConnection::class)
            ->needs(\Illuminate\Database\Connection::class)
            ->give(function ($app) {
                $tenant = $app->make(\App\Services\TenantManager::class)->current();
                return $app->make('db')->connection("tenant_{$tenant->id}");
            });
    }

    public function boot(): void
    {
        // Set tenant berdasarkan subdomain
        $this->app->make(\Illuminate\Http\Request::class)->macro('tenant', function () {
            return app(\App\Services\TenantManager::class)->current();
        });

        // Middleware untuk switch tenant
        $this->app->make(\Illuminate\Contracts\Http\Kernel::class)
            ->prependMiddleware(\App\Http\Middleware\IdentifyTenant::class);
    }
}
```

---

## 12.4 Package Discovery dan Auto-Registration

### 12.4.1 Package Auto-Discovery

Laravel 5.5+ secara otomatis mendeteksi service providers dari package Composer.

```php
<?php

// composer.json dari package

{
    "name": "vendor/laravel-analytics",
    "extra": {
        "laravel": {
            "providers": [
                "Vendor\\Analytics\\AnalyticsServiceProvider"
            ],
            "aliases": {
                "Analytics": "Vendor\\Analytics\\Facades\\Analytics"
            }
        }
    }
}
```

### 12.4.2 Manual Package Registration

Jika tidak menggunakan auto-discovery:

```php
<?php

// config/app.php

'providers' => [
    // ...
    \Vendor\Analytics\AnalyticsServiceProvider::class,
],

'aliases' => [
    // ...
    'Analytics' => \Vendor\Analytics\Facades\Analytics::class,
],
```

### 12.4.3 Conditional Provider Registration

```php
<?php

namespace Vendor\Analytics;

use Illuminate\Support\ServiceProvider;

class AnalyticsServiceProvider extends ServiceProvider
{
    public function register(): void
    {
        // Hanya register jika config di-enable
        if (!$this->app['config']['analytics.enabled']) {
            return;
        }

        $this->app->singleton(AnalyticsClient::class, function ($app) {
            return new AnalyticsClient($app['config']['analytics.api_key']);
        });
    }

    public function boot(): void
    {
        if (!$this->app['config']['analytics.enabled']) {
            return;
        }

        $this->loadMigrationsFrom(__DIR__.'/../database/migrations');
        $this->loadRoutesFrom(__DIR__.'/../routes/analytics.php');
        $this->loadViewsFrom(__DIR__.'/../resources/views', 'analytics');
        $this->loadTranslationsFrom(__DIR__.'/../lang', 'analytics');

        // Publishing
        if ($this->app->runningInConsole()) {
            $this->publishes([
                __DIR__.'/../config/analytics.php' => config_path('analytics.php'),
            ], 'analytics-config');

            $this->publishes([
                __DIR__.'/../resources/views' => resource_path('views/vendor/analytics'),
            ], 'analytics-views');
        }
    }
}
```

### 12.4.4 Publishing Package Assets

```bash
# Publish semua assets
php artisan vendor:publish

# Publish config spesifik
php artisan vendor:publish --tag=analytics-config

# Publish views
php artisan vendor:publish --tag=analytics-views

# Publish dari provider spesifik
php artisan vendor:publish --provider="Vendor\Analytics\AnalyticsServiceProvider"
```

---

## 12.5 Provider Ordering dan Dependencies

### 12.5.1 Mengatur Urutan Provider

```php
<?php

// config/app.php

'providers' => [
    // 1. Foundation providers (harus pertama)
    \Illuminate\Foundation\Providers\FoundationServiceProvider::class,
    
    // 2. Core service providers
    \Illuminate\Auth\AuthServiceProvider::class,
    \Illuminate\Cache\CacheServiceProvider::class,
    
    // 3. Database providers
    \Illuminate\Database\DatabaseServiceProvider::class,
    
    // 4. Custom foundation providers
    \App\Providers\AppServiceProvider::class,
    
    // 5. Feature providers (bergantung pada di atas)
    \App\Providers\RepositoryServiceProvider::class,
    \App\Providers\PaymentServiceProvider::class,
    
    // 6. Route provider (terakhir)
    \App\Providers\RouteServiceProvider::class,
];
```

### 12.5.2 Provider Dependencies

```php
<?php

namespace App\Providers;

use Illuminate\Support\ServiceProvider;

class PaymentServiceProvider extends ServiceProvider
{
    /**
     * Providers yang harus di-load terlebih dahulu
     */
    public array $bindings = [];

    public function register(): void
    {
        // Pastikan EventServiceProvider sudah terdaftar
        if (!$this->app->providerIsLoaded(\App\Providers\EventServiceProvider::class)) {
            throw new \RuntimeException('EventServiceProvider must be loaded before PaymentServiceProvider');
        }

        $this->app->singleton(PaymentService::class, function ($app) {
            return new PaymentService($app['events']);
        });
    }
}
```

### 12.5.3 Booting Callback

```php
<?php

public function boot(): void
{
    // Jalankan setelah semua providers selesai booting
    $this->app->booted(function () {
        // Semua providers sudah booted
        $this->initializeThirdPartySdk();
    });

    // Atau sebelum booting selesai
    $this->app->booting(function () {
        // Sedang dalam proses booting
    });
}
```

---

## 12.6 Advanced Provider Patterns

### 12.6.1 Dynamic Provider Registration

```php
<?php

namespace App\Providers;

use Illuminate\Support\ServiceProvider;

class FeatureFlagServiceProvider extends ServiceProvider
{
    public function register(): void
    {
        // Register providers berdasarkan feature flag
        $features = config('features');

        if ($features['new_dashboard']) {
            $this->app->register(NewDashboardServiceProvider::class);
        } else {
            $this->app->register(LegacyDashboardServiceProvider::class);
        }

        if ($features['beta_api']) {
            $this->app->register(BetaApiServiceProvider::class);
        }
    }

    public function boot(): void
    {
        // Dynamic blade component registration
        if (config('features.new_ui')) {
            \Blade::component('ui-new.button', 'button');
        } else {
            \Blade::component('ui-legacy.button', 'button');
        }
    }
}
```

### 12.6.2 Environment-Specific Providers

```php
<?php

// bootstrap/providers.php (Laravel 11+)

return [
    \App\Providers\AppServiceProvider::class,
    
    // Providers khusus environment
    ...(match (app()->environment()) {
        'local' => [
            \App\Providers\TelescopeServiceProvider::class,
            \App\Providers\HorizonServiceProvider::class,
            \App\Providers\DebugbarServiceProvider::class,
        ],
        'testing' => [
            \App\Providers\TestingServiceProvider::class,
        ],
        'production' => [
            \App\Providers\SentryServiceProvider::class,
            \App\Providers\NewRelicServiceProvider::class,
        ],
        default => [],
    }),
];
```

### 12.6.3 Provider dengan Macro

```php
<?php

namespace App\Providers;

use Illuminate\Support\ServiceProvider;
use Illuminate\Support\Collection;

class CollectionMacroServiceProvider extends ServiceProvider
{
    public function boot(): void
    {
        // Register collection macros
        Collection::macro('toCsv', function () {
            $headers = array_keys($this->first()->toArray());
            
            $lines = $this->map(function ($item) {
                return implode(',', array_values($item->toArray()));
            })->toArray();
            
            return implode("\n", array_merge([implode(',', $headers)], $lines));
        });

        Collection::macro('paginate', function ($perPage) {
            $page = request()->input('page', 1);
            $total = $this->count();
            
            return new \Illuminate\Pagination\LengthAwarePaginator(
                $this->forPage($page, $perPage),
                $total,
                $perPage,
                $page,
                ['path' => request()->url()]
            );
        });
    }
}
```

---

## 12.7 Kesimpulan

Service Providers adalah fondasi modularitas Laravel:

| Konsep | Fungsi |
|--------|--------|
| `register()` | Binding ke container, setup dasar |
| `boot()` | Menggunakan services, setup lanjutan |
| Deferred Provider | Lazy loading untuk performance |
| Package Discovery | Auto-registration dari Composer |
| Publishing | Share config/views/lang ke application |

**Best Practices:**
- Jangan akses services lain di `register()`
- Gunakan deferred providers untuk services jarang digunakan
- Kelompokkan provider berdasarkan fitur/domain
- Dokumentasikan dependencies antar provider
- Gunakan `provides()` untuk deferred providers
- Leverage package discovery untuk seamless integration

**Troubleshooting:**

```php
<?php

// Debug provider loading
php artisan tinker
>>> app()->getLoadedProviders()

// Check service bound atau tidak
>>> app()->bound(\App\Services\PaymentService::class)

// Force load deferred provider
>>> app()->loadDeferredProvider(\App\Services\AnalyticsService::class)
```
```
